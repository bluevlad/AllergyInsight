# 3. 도메인 모델 (Domain Model)

## 3.1 핵심 도메인 개념

### 유비쿼터스 언어 (Ubiquitous Language)

| 용어 (한글) | 용어 (영문) | 정의 |
|-------------|-------------|------|
| 알러젠 | Allergen | 알러지 반응을 유발하는 물질 (예: 땅콩, 우유) |
| 등급 | Grade | 알러젠에 대한 감작 정도 (0-6) |
| 진단 | Diagnosis | 환자의 알러젠별 등급 검사 결과 |
| 처방 권고 | Prescription | 진단 결과에 따른 권고 사항 |
| 회피 식품 | Avoid Foods | 섭취를 피해야 하는 식품 |
| 대체 식품 | Substitutes | 회피 식품 대신 섭취 가능한 식품 |
| 교차반응 | Cross Reactivity | 다른 알러젠에도 반응할 확률 |
| 숨겨진 알러젠 | Hidden Sources | 예상치 못한 곳에 포함된 알러젠 |
| 키트 | Kit | 검사에 사용되는 진단 키트 |

### 도메인 영역

```
┌─────────────────────────────────────────────────────────────┐
│                      AllergyInsight Domain                   │
├─────────────────┬─────────────────┬─────────────────────────┤
│    Core Domain  │ Supporting Domain│   Generic Domain       │
├─────────────────┼─────────────────┼─────────────────────────┤
│                 │                 │                         │
│ • 진단 관리      │ • 환자 관리      │ • 사용자 인증            │
│ • 처방 엔진      │ • 조직 관리      │ • 파일 저장              │
│ • 알러젠 지식    │ • 논문 관리      │ • 알림                  │
│                 │ • 키트 관리      │ • 로깅                  │
│                 │                 │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
```

---

## 3.2 ER 다이어그램

### 전체 ER 다이어그램

```
┌──────────────────┐       ┌──────────────────┐
│       User       │       │   Organization   │
├──────────────────┤       ├──────────────────┤
│ id (PK)          │       │ id (PK)          │
│ name             │       │ name             │
│ email            │       │ type             │
│ phone            │       │ address          │
│ birth_date       │       │ phone            │
│ role             │◀──────│ admin_user_id(FK)│
│ access_pin       │       │ status           │
│ is_active        │       │ created_at       │
│ created_at       │       └──────────────────┘
└────────┬─────────┘                │
         │                          │
         │ 1:N                      │ 1:N
         ▼                          ▼
┌──────────────────┐       ┌──────────────────┐
│  UserDiagnosis   │       │OrganizationMember│
├──────────────────┤       ├──────────────────┤
│ id (PK)          │       │ id (PK)          │
│ user_id (FK)     │       │ org_id (FK)      │
│ diagnosis_date   │       │ user_id (FK)     │
│ results (JSON)   │       │ role             │
│ summary (JSON)   │       │ joined_at        │
│ created_at       │       └──────────────────┘
└────────┬─────────┘
         │
         │ 1:1
         ▼
┌──────────────────┐       ┌──────────────────┐
│  DiagnosisKit    │       │ HospitalPatient  │
├──────────────────┤       ├──────────────────┤
│ id (PK)          │       │ id (PK)          │
│ serial_number    │       │ org_id (FK)      │
│ pin_hash         │       │ user_id (FK)     │
│ status           │       │ patient_number   │
│ test_date        │       │ assigned_doctor  │
│ diagnosis_id(FK) │       │ consent_signed   │
│ registered_by    │       │ registered_at    │
│ created_at       │       └──────────────────┘
└──────────────────┘

┌──────────────────┐       ┌──────────────────┐
│      Paper       │       │ PaperAllergenLink│
├──────────────────┤       ├──────────────────┤
│ id (PK)          │       │ id (PK)          │
│ title            │◀──────│ paper_id (FK)    │
│ authors          │       │ allergen_code    │
│ journal          │       │ link_type        │
│ year             │       │ item_name        │
│ doi              │       │ confidence       │
│ abstract         │       │ created_at       │
│ paper_type       │       └──────────────────┘
│ created_at       │
└──────────────────┘
```

### 관계 요약

| 관계 | 설명 |
|------|------|
| User → UserDiagnosis | 1:N (한 사용자가 여러 진단 보유) |
| User → OrganizationMember | 1:N (한 사용자가 여러 조직 소속 가능) |
| Organization → OrganizationMember | 1:N (한 조직에 여러 멤버) |
| Organization → HospitalPatient | 1:N (한 병원에 여러 환자) |
| UserDiagnosis → DiagnosisKit | 1:1 (하나의 키트로 하나의 진단) |
| Paper → PaperAllergenLink | 1:N (한 논문이 여러 알러젠 연결) |

---

## 3.3 엔티티 명세

### User (사용자)

```python
class User(Base):
    """사용자 엔티티"""
    __tablename__ = "users"

    id: int                    # Primary Key
    name: str                  # 이름 (필수)
    email: str | None          # 이메일 (Google OAuth 시)
    phone: str | None          # 전화번호 (간편 인증 시)
    birth_date: date | None    # 생년월일
    role: UserRole             # 역할 (Enum)
    google_id: str | None      # Google OAuth ID
    access_pin: str | None     # 접속 PIN (해시)
    is_active: bool            # 활성 상태
    created_at: datetime       # 생성일시
    updated_at: datetime       # 수정일시
```

#### UserRole Enum

| 값 | 설명 | Professional API | Consumer API |
|----|------|-----------------|--------------|
| `patient` | 환자 | ❌ | ✅ |
| `doctor` | 의사 | ✅ | ✅ |
| `nurse` | 간호사 | ✅ | ✅ |
| `lab_tech` | 검사 기사 | ✅ (제한) | ✅ |
| `hospital_admin` | 병원 관리자 | ✅ | ✅ |
| `admin` | 시스템 관리자 | ✅ | ✅ |
| `super_admin` | 슈퍼 관리자 | ✅ | ✅ |

### UserDiagnosis (사용자 진단)

```python
class UserDiagnosis(Base):
    """사용자 진단 결과"""
    __tablename__ = "user_diagnoses"

    id: int                    # Primary Key
    user_id: int               # Foreign Key → User
    diagnosis_date: datetime   # 검사일
    results: dict              # 알러젠별 등급 (JSON)
    summary: dict | None       # 요약 정보 (JSON)
    created_at: datetime       # 생성일시
    created_by: int | None     # 입력자 (FK → User)
```

#### results JSON 구조

```json
{
  "allergens": [
    {"code": "peanut", "grade": 4, "name_ko": "땅콩"},
    {"code": "milk", "grade": 2, "name_ko": "우유"},
    {"code": "egg", "grade": 0, "name_ko": "계란"}
  ],
  "test_type": "SGTi-Allergy Screen PLUS",
  "kit_serial": "SGT-2024-XXXXX"
}
```

### DiagnosisKit (진단 키트)

```python
class DiagnosisKit(Base):
    """진단 키트"""
    __tablename__ = "diagnosis_kits"

    id: int                    # Primary Key
    serial_number: str         # 시리얼 번호 (Unique)
    pin_hash: str              # PIN 해시
    status: KitStatus          # 상태 (Enum)
    test_date: datetime | None # 검사일
    diagnosis_id: int | None   # FK → UserDiagnosis
    registered_by: int | None  # 등록자 (FK → User)
    created_at: datetime       # 생성일시
```

#### KitStatus Enum

| 값 | 설명 |
|----|------|
| `created` | 생성됨 (검사 전) |
| `tested` | 검사 완료 (결과 입력 대기) |
| `result_entered` | 결과 입력 완료 |
| `registered` | 사용자 등록 완료 |
| `expired` | 만료됨 |

### Organization (조직)

```python
class Organization(Base):
    """조직 (병원, 클리닉 등)"""
    __tablename__ = "organizations"

    id: int                    # Primary Key
    name: str                  # 조직명
    type: OrgType              # 유형 (Enum)
    address: str | None        # 주소
    phone: str | None          # 전화번호
    admin_user_id: int         # 관리자 (FK → User)
    status: OrgStatus          # 상태 (Enum)
    created_at: datetime       # 생성일시
```

### Paper (논문)

```python
class Paper(Base):
    """논문/출처"""
    __tablename__ = "papers"

    id: int                    # Primary Key
    title: str                 # 제목
    authors: list[str]         # 저자 목록
    journal: str | None        # 저널명
    year: int | None           # 발행연도
    doi: str | None            # DOI
    pmid: str | None           # PubMed ID
    abstract: str | None       # 초록
    paper_type: PaperType      # 유형 (Enum)
    created_at: datetime       # 생성일시
```

---

## 3.4 비즈니스 규칙

### 등급 체계 (Grade System)

| 등급 | IgE 수치 | 임상적 의미 | 권고 수준 |
|------|----------|-------------|----------|
| 0 | < 0.35 | 음성 | 제한 없음 |
| 1 | 0.35 - 0.69 | 경계 | 모니터링 |
| 2 | 0.70 - 3.49 | 약양성 | 주의 섭취 |
| 3 | 3.50 - 17.49 | 양성 | 제한 섭취 |
| 4 | 17.50 - 49.99 | 강양성 | 회피 권고 |
| 5 | 50.00 - 99.99 | 매우 강양성 | 완전 회피 |
| 6 | ≥ 100.00 | 극강양성 | 완전 회피 + 응급약 휴대 |

### 처방 권고 생성 규칙

```
IF 등급 >= 4 THEN
    - 해당 알러젠 완전 회피
    - 숨겨진 알러젠 경고
    - 교차반응 알러젠 주의
    - 대체 식품 제안

IF 등급 >= 5 THEN
    - 위 내용 + 응급 대처법
    - 에피펜 휴대 권고

IF 등급 == 6 THEN
    - 위 내용 + 즉시 전문의 상담
    - 아나필락시스 대비
```

### 알러젠 분류

| 카테고리 | 알러젠 |
|----------|--------|
| **식품 (Food)** | 땅콩, 우유, 계란, 밀, 대두, 생선, 갑각류, 견과류, 참깨 |
| **흡입 (Inhalant)** | 집먼지진드기, 고양이, 개, 바퀴벌레, 곰팡이, 꽃가루, 쑥 |

### 교차반응 규칙

```python
CROSS_REACTIVITY = {
    "peanut": [
        {"allergen": "tree_nuts", "probability": "high"},
        {"allergen": "soy", "probability": "moderate"},
    ],
    "milk": [
        {"allergen": "beef", "probability": "low"},
        {"allergen": "goat_milk", "probability": "high"},
    ],
    # ...
}
```

---

## 3.5 상태 다이어그램

### DiagnosisKit 상태 전이

```
                    ┌────────────┐
                    │  created   │ ←── 키트 생성
                    └─────┬──────┘
                          │ 검사 수행
                          ▼
                    ┌────────────┐
                    │   tested   │ ←── 검사 완료
                    └─────┬──────┘
                          │ 결과 입력
                          ▼
                    ┌────────────┐
                    │result_entered│ ←── 결과 입력 완료
                    └─────┬──────┘
                          │ 사용자 등록
                          ▼
                    ┌────────────┐
                    │ registered │ ←── 등록 완료
                    └────────────┘

         (유효기간 초과 시 어느 단계에서든)
                          │
                          ▼
                    ┌────────────┐
                    │  expired   │
                    └────────────┘
```

### Organization 상태 전이

```
    ┌─────────────┐
    │   pending   │ ←── 승인 대기
    └──────┬──────┘
           │ 관리자 승인
           ▼
    ┌─────────────┐
    │   active    │ ←── 활성
    └──────┬──────┘
           │ 비활성화
           ▼
    ┌─────────────┐
    │  inactive   │ ←── 비활성
    └─────────────┘
```

---

## 3.6 집계 (Aggregates)

### User Aggregate

```
┌─────────────────────────────────────────┐
│              User Aggregate              │
├─────────────────────────────────────────┤
│                                         │
│   ┌─────────┐                           │
│   │  User   │ (Aggregate Root)          │
│   └────┬────┘                           │
│        │                                │
│   ┌────┴────┐    ┌──────────────────┐   │
│   │Diagnoses│───▶│  DiagnosisKit    │   │
│   └─────────┘    └──────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### Organization Aggregate

```
┌─────────────────────────────────────────┐
│          Organization Aggregate          │
├─────────────────────────────────────────┤
│                                         │
│   ┌──────────────┐                      │
│   │ Organization │ (Aggregate Root)     │
│   └──────┬───────┘                      │
│          │                              │
│   ┌──────┴───────┐   ┌───────────────┐  │
│   │   Members    │   │   Patients    │  │
│   └──────────────┘   └───────────────┘  │
│                                         │
└─────────────────────────────────────────┘
```

---

[← 아키텍처](./2.-Architecture) | [다음: API 명세 →](./4.-API-Specification)
