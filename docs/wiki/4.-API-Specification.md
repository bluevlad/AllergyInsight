# 4. API 명세 (API Specification)

## 4.1 API 설계 원칙

### RESTful 원칙

| 원칙 | 적용 |
|------|------|
| **리소스 기반** | URL은 리소스를 나타냄 (`/api/pro/patients`) |
| **HTTP 메서드** | GET(조회), POST(생성), PUT(수정), DELETE(삭제) |
| **상태 코드** | 200(성공), 201(생성), 400(요청오류), 401(인증필요), 403(권한없음), 404(없음), 500(서버오류) |
| **JSON 형식** | 요청/응답 본문은 JSON |

### API 버전

- **현재 버전**: v2.0.0
- **Base URL**: `http://localhost:9040/api`

### 공통 응답 형식

```json
// 성공 응답
{
  "success": true,
  "data": { ... },
  "message": "성공 메시지"
}

// 에러 응답
{
  "detail": "에러 메시지",
  "code": "ERROR_CODE"
}
```

---

## 4.2 인증/인가 (Authentication)

### 인증 방식

| 방식 | 용도 | 엔드포인트 |
|------|------|----------|
| **Google OAuth** | 소셜 로그인 | `/api/auth/google/login` |
| **Simple Auth** | 간편 로그인 (이름 + PIN) | `/api/auth/simple/login` |
| **JWT Token** | API 인증 | `Authorization: Bearer <token>` |

### 인증 API

#### Google OAuth 로그인

```http
GET /api/auth/google/login
```

**Response**: 302 Redirect to Google OAuth

---

#### Google OAuth 콜백

```http
GET /api/auth/google/callback?code={code}
```

**Response**: 302 Redirect to Frontend with token

---

#### 간편 회원가입

```http
POST /api/auth/simple/register
Content-Type: application/json

{
  "name": "홍길동",
  "phone": "010-1234-5678",        // phone 또는 birth_date 중 하나 필수
  "birth_date": null,
  "serial_number": "SGT-2024-XXXXX",
  "pin": "123456"
}
```

**Response (201)**
```json
{
  "user": {
    "id": 1,
    "name": "홍길동",
    "role": "patient"
  },
  "access_token": "eyJ...",
  "access_pin": "715302"  // 최초 1회만 반환
}
```

---

#### 간편 로그인

```http
POST /api/auth/simple/login
Content-Type: application/json

{
  "name": "홍길동",
  "phone": "010-1234-5678",
  "access_pin": "715302"
}
```

**Response (200)**
```json
{
  "user": {
    "id": 1,
    "name": "홍길동",
    "role": "patient"
  },
  "access_token": "eyJ..."
}
```

---

#### 현재 사용자 정보

```http
GET /api/auth/me
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "id": 1,
  "name": "홍길동",
  "email": null,
  "phone": "010-1234-5678",
  "role": "patient",
  "is_active": true
}
```

---

#### 로그아웃

```http
POST /api/auth/logout
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "message": "로그아웃 되었습니다."
}
```

---

## 4.3 Professional API (`/api/pro/*`)

### 진단 관리

#### 진단 입력

```http
POST /api/pro/diagnosis
Authorization: Bearer {token}
Content-Type: application/json

{
  "patient_id": 5,
  "diagnosis_date": "2024-01-15",
  "results": [
    {"allergen": "peanut", "grade": 4},
    {"allergen": "milk", "grade": 2},
    {"allergen": "egg", "grade": 0}
  ],
  "kit_serial": "SGT-2024-XXXXX"
}
```

**Response (201)**
```json
{
  "success": true,
  "diagnosis_id": 123,
  "prescription": {
    "high_risk": [
      {
        "allergen": "peanut",
        "grade": 4,
        "avoid_foods": ["땅콩", "땅콩버터", "땅콩오일"],
        "hidden_sources": ["초콜릿", "아이스크림", "소스류"],
        "substitutes": ["해바라기씨", "호박씨"],
        "cross_reactivity": [
          {"allergen": "tree_nuts", "probability": "high"}
        ]
      }
    ],
    "moderate_risk": [...],
    "low_risk": [...],
    "emergency_plan": {...}
  }
}
```

---

#### 진단 조회

```http
GET /api/pro/diagnosis/{diagnosis_id}
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "id": 123,
  "patient": {
    "id": 5,
    "name": "김환자"
  },
  "diagnosis_date": "2024-01-15",
  "results": [...],
  "prescription": {...},
  "created_at": "2024-01-15T10:30:00Z",
  "created_by": {
    "id": 2,
    "name": "이의사"
  }
}
```

---

#### 환자별 진단 이력

```http
GET /api/pro/diagnosis/patient/{patient_id}
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "patient": {
    "id": 5,
    "name": "김환자"
  },
  "diagnoses": [
    {
      "id": 123,
      "diagnosis_date": "2024-01-15",
      "summary": {
        "high_risk_count": 2,
        "max_grade": 4
      }
    }
  ],
  "total": 3
}
```

---

### 환자 관리

#### 환자 목록

```http
GET /api/pro/patients?search={keyword}&page=1&limit=20
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "items": [
    {
      "id": 5,
      "name": "김환자",
      "phone": "010-****-5678",
      "last_diagnosis": "2024-01-15",
      "diagnosis_count": 3
    }
  ],
  "total": 50,
  "page": 1,
  "pages": 3
}
```

---

#### 환자 등록 (신규)

```http
POST /api/pro/patients/new
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "박신규",
  "phone": "010-9876-5432",
  "birth_date": "1990-05-15",
  "consent": true
}
```

**Response (201)**
```json
{
  "success": true,
  "patient_id": 10,
  "patient_number": "P-2024-0010",
  "message": "환자가 등록되었습니다."
}
```

---

#### 환자 상세

```http
GET /api/pro/patients/{patient_id}
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "id": 5,
  "name": "김환자",
  "phone": "010-1234-5678",
  "birth_date": "1985-03-20",
  "patient_number": "P-2024-0005",
  "assigned_doctor": {
    "id": 2,
    "name": "이의사"
  },
  "consent_signed": true,
  "diagnosis_count": 3,
  "last_diagnosis": "2024-01-15",
  "registered_at": "2023-06-01T09:00:00Z"
}
```

---

### 연구 (Research)

#### 논문 검색

```http
POST /api/pro/research/search
Authorization: Bearer {token}
Content-Type: application/json

{
  "query": "peanut allergy treatment",
  "allergen": "peanut",
  "include_cross_reactivity": true,
  "max_results": 20
}
```

**Response (200)**
```json
{
  "success": true,
  "query": "peanut allergy treatment",
  "total_found": 45,
  "papers": [
    {
      "id": "pubmed:12345678",
      "title": "Novel approaches to peanut allergy",
      "authors": ["Smith J", "Johnson M"],
      "journal": "J Allergy Clin Immunol",
      "year": 2023,
      "abstract": "...",
      "doi": "10.1016/j.jaci.2023.01.001",
      "score": 0.95
    }
  ]
}
```

---

#### Q&A

```http
POST /api/pro/research/qa
Authorization: Bearer {token}
Content-Type: application/json

{
  "question": "땅콩 알러지 환자가 피해야 할 숨겨진 식품은?",
  "allergen": "peanut",
  "max_citations": 5
}
```

**Response (200)**
```json
{
  "success": true,
  "question": "땅콩 알러지 환자가 피해야 할 숨겨진 식품은?",
  "answer": "땅콩 알러지 환자는 다음 식품에 주의해야 합니다: 1) 초콜릿 및 캔디류...",
  "confidence": 0.85,
  "citations": [
    {
      "paper_id": "pubmed:12345678",
      "title": "Hidden peanut allergens in processed foods",
      "excerpt": "..."
    }
  ]
}
```

---

### 대시보드

#### 통계 조회

```http
GET /api/pro/dashboard/stats
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "period": "2024-01",
  "diagnoses": {
    "total": 150,
    "this_month": 45,
    "trend": "+12%"
  },
  "patients": {
    "total": 120,
    "new_this_month": 15
  },
  "allergen_distribution": [
    {"allergen": "peanut", "count": 35, "percentage": 23.3},
    {"allergen": "milk", "count": 28, "percentage": 18.7}
  ],
  "grade_distribution": [
    {"grade": 0, "count": 50},
    {"grade": 1, "count": 30},
    {"grade": 2, "count": 25}
  ]
}
```

---

## 4.4 Consumer API (`/api/consumer/*`)

### 내 진단

#### 진단 목록

```http
GET /api/consumer/my/diagnoses
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "items": [
    {
      "id": 123,
      "diagnosis_date": "2024-01-15",
      "summary": {
        "high_risk_allergens": ["땅콩"],
        "max_grade": 4,
        "total_tested": 16
      }
    }
  ],
  "total": 3
}
```

---

#### 진단 상세

```http
GET /api/consumer/my/diagnoses/{diagnosis_id}
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "id": 123,
  "diagnosis_date": "2024-01-15",
  "results": [
    {
      "allergen": "peanut",
      "name_ko": "땅콩",
      "grade": 4,
      "grade_description": "강양성",
      "risk_level": "high"
    }
  ],
  "guide": {
    "avoid_foods": [...],
    "substitutes": [...],
    "lifestyle_tips": [...],
    "emergency_info": {...}
  }
}
```

---

#### 환자 가이드

```http
GET /api/consumer/my/diagnoses/{diagnosis_id}/guide
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "symptoms": {
    "high_risk": [
      {
        "allergen": "땅콩",
        "symptoms": ["두드러기", "구강 가려움", "호흡곤란"]
      }
    ]
  },
  "diet_management": {
    "avoid": ["땅콩", "땅콩버터", "땅콩오일"],
    "hidden_sources": ["초콜릿", "아이스크림"],
    "substitutes": ["해바라기씨", "호박씨"],
    "cross_reactivity": [...]
  },
  "emergency": {
    "anaphylaxis_signs": [...],
    "action_plan": [...],
    "epinephrine_guide": {...}
  }
}
```

---

### 가이드

#### 식품 가이드

```http
GET /api/consumer/guide/foods
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "avoid_foods": [
    {
      "allergen": "땅콩",
      "foods": ["땅콩", "땅콩버터", "땅콩오일", "땅콩가루"]
    }
  ],
  "substitutes": [
    {
      "allergen": "땅콩",
      "original": "땅콩버터",
      "alternatives": ["해바라기씨버터", "아몬드버터"]
    }
  ],
  "hidden_sources": [
    {
      "allergen": "땅콩",
      "sources": ["초콜릿", "아이스크림", "소스류", "베이커리"]
    }
  ]
}
```

---

#### 교차반응 정보

```http
GET /api/consumer/guide/cross-reactivity/{allergen_code}
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "allergen": "peanut",
  "allergen_name": "땅콩",
  "cross_reactivity": [
    {
      "to_allergen": "tree_nuts",
      "to_name": "견과류",
      "probability": "high",
      "related_foods": ["호두", "아몬드", "캐슈넛"]
    }
  ]
}
```

---

#### 생활 관리

```http
GET /api/consumer/guide/lifestyle
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "allergen_specific": [
    {
      "allergen": "집먼지진드기",
      "tips": [
        "침구류 주 1회 고온 세탁",
        "카펫 대신 마루 사용"
      ]
    }
  ],
  "common_tips": [
    {
      "category": "실내 환경",
      "title": "공기 청정",
      "tips": ["HEPA 필터 공기청정기 사용", "습도 50% 유지"]
    }
  ]
}
```

---

### 응급 대처

#### 응급 가이드라인

```http
GET /api/consumer/emergency/guidelines
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "severity_levels": [
    {
      "level": "mild",
      "symptoms": ["피부 가려움", "국소 두드러기"],
      "actions": ["항히스타민제 복용", "증상 관찰"]
    },
    {
      "level": "severe",
      "symptoms": ["호흡곤란", "혈압저하", "의식저하"],
      "actions": ["에피펜 투여", "119 신고", "누운 자세 유지"]
    }
  ],
  "emergency_contacts": {
    "emergency": "119",
    "poison_center": "1339"
  }
}
```

---

#### 응급 행동 계획

```http
GET /api/consumer/emergency/action-plan
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "action_plans": {
    "mild": {
      "title": "경미한 증상",
      "symptoms": [...],
      "actions": [...],
      "when_to_call_doctor": "증상이 2시간 이상 지속되는 경우"
    },
    "severe": {
      "title": "심각한 증상 (아나필락시스)",
      "symptoms": [...],
      "actions": [...],
      "epinephrine_instructions": [...]
    }
  }
}
```

---

#### 에피펜 사용법

```http
GET /api/consumer/emergency/epinephrine
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "what_is_epinephrine": {
    "description": "아나필락시스 응급 치료제",
    "prescription_required": true
  },
  "when_to_use": [
    "호흡곤란",
    "목이 붓는 느낌",
    "어지러움/의식저하"
  ],
  "how_to_use": {
    "preparation": ["안전캡 제거", "주사 부위 확인"],
    "injection": ["허벅지 바깥쪽에 90도로 삽입", "10초간 유지"],
    "after_injection": ["즉시 119 신고", "사용한 주사기 보관"]
  },
  "storage": [
    "실온 보관 (15-25°C)",
    "직사광선 피하기",
    "유효기간 확인"
  ]
}
```

---

### 키트 등록

#### 키트 등록

```http
POST /api/consumer/kit/register
Authorization: Bearer {token}
Content-Type: application/json

{
  "serial_number": "SGT-2024-XXXXX",
  "pin": "123456"
}
```

**Response (200)**
```json
{
  "success": true,
  "message": "키트가 등록되었습니다.",
  "diagnosis_id": 123
}
```

---

#### 키트 상태 확인

```http
GET /api/consumer/kit/status/{serial_number}
Authorization: Bearer {token}
```

**Response (200)**
```json
{
  "serial_number": "SGT-2024-XXXXX",
  "status": "result_entered",
  "message": "검사 결과가 입력되었습니다. 등록 가능합니다.",
  "test_date": "2024-01-15"
}
```

---

## 4.5 에러 코드 및 처리

### HTTP 상태 코드

| 코드 | 의미 | 설명 |
|------|------|------|
| 200 | OK | 요청 성공 |
| 201 | Created | 리소스 생성 성공 |
| 400 | Bad Request | 잘못된 요청 |
| 401 | Unauthorized | 인증 필요 |
| 403 | Forbidden | 권한 없음 |
| 404 | Not Found | 리소스 없음 |
| 422 | Unprocessable Entity | 검증 실패 |
| 500 | Internal Server Error | 서버 오류 |

### 에러 응답 형식

```json
{
  "detail": "상세 에러 메시지",
  "code": "ERROR_CODE",
  "field": "필드명 (검증 오류 시)"
}
```

### 주요 에러 코드

| 코드 | 설명 | HTTP 상태 |
|------|------|----------|
| `AUTH_INVALID_TOKEN` | 유효하지 않은 토큰 | 401 |
| `AUTH_EXPIRED_TOKEN` | 만료된 토큰 | 401 |
| `AUTH_INVALID_CREDENTIALS` | 잘못된 인증 정보 | 401 |
| `FORBIDDEN_ROLE` | 역할 권한 없음 | 403 |
| `PATIENT_NOT_FOUND` | 환자를 찾을 수 없음 | 404 |
| `DIAGNOSIS_NOT_FOUND` | 진단을 찾을 수 없음 | 404 |
| `KIT_ALREADY_REGISTERED` | 이미 등록된 키트 | 400 |
| `KIT_INVALID_PIN` | 잘못된 PIN | 400 |
| `VALIDATION_ERROR` | 입력값 검증 실패 | 422 |

---

## 4.6 API 테스트

### Swagger UI

- URL: `http://localhost:9040/docs`
- 인증: Authorize 버튼 → Bearer Token 입력

### 테스트 예시 (cURL)

```bash
# 로그인
curl -X POST http://localhost:9040/api/auth/simple/login \
  -H "Content-Type: application/json" \
  -d '{"name":"김철수","phone":"010-9999-8888","access_pin":"715302"}'

# API 호출 (토큰 사용)
curl -X GET http://localhost:9040/api/consumer/my/diagnoses \
  -H "Authorization: Bearer eyJ..."
```

---

[← 도메인 모델](./3.-Domain-Model) | [다음: 개발 가이드 →](./5.-Development-Guide)
