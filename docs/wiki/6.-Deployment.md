# 6. 배포 가이드 (Deployment Guide)

## 6.1 배포 환경

### 환경 구성

| 환경 | 용도 | URL | 브랜치 |
|------|------|-----|--------|
| **Local** | 개발 | localhost:4040 | feature/* |
| **Test** | 테스트 | localhost:4041 | develop |
| **Production** | 운영 | localhost:4040 | prod |

### 인프라 구성

```
┌─────────────────────────────────────────────────────────────┐
│                    Production Server                         │
│                   (Windows Self-hosted)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│   │   Nginx     │   │   Docker    │   │   GitHub    │      │
│   │   (Proxy)   │   │   Compose   │   │   Actions   │      │
│   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘      │
│          │                 │                 │              │
│          │    ┌────────────┴────────────┐    │              │
│          │    │                         │    │              │
│          ▼    ▼                         ▼    │              │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│   │  Frontend   │   │  Backend    │   │  PostgreSQL │      │
│   │   :4040     │   │   :9040     │   │    :5432    │      │
│   └─────────────┘   └─────────────┘   └─────────────┘      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6.2 Docker 배포

### docker-compose.yml

```yaml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "4040:80"
    depends_on:
      - backend
    environment:
      - VITE_API_URL=http://localhost:9040
    networks:
      - allergyinsight

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "9040:9040"
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/allergyinsight
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRE_HOURS=24
    networks:
      - allergyinsight

  db:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=allergyinsight
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - allergyinsight

volumes:
  postgres_data:

networks:
  allergyinsight:
    driver: bridge
```

### 배포 명령어

```bash
# 전체 빌드 및 실행
docker-compose up -d --build

# 특정 서비스만 재빌드
docker-compose up -d --build backend

# 로그 확인
docker-compose logs -f

# 서비스 중지
docker-compose down

# 볼륨 포함 완전 삭제
docker-compose down -v
```

### Dockerfile (Backend)

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 시스템 의존성
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 소스 코드
COPY . .

# 포트 노출
EXPOSE 9040

# 실행
CMD ["uvicorn", "app.api.main:app", "--host", "0.0.0.0", "--port", "9040"]
```

### Dockerfile (Frontend)

```dockerfile
# Build stage
FROM node:20-alpine as build

WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Production stage
FROM nginx:alpine

COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

---

## 6.3 CI/CD 파이프라인

### GitHub Actions 워크플로우

```yaml
# .github/workflows/deploy-prod.yml
name: Deploy to Production

on:
  push:
    branches: [prod]

jobs:
  deploy:
    runs-on: [self-hosted, Windows]

    steps:
      - name: Configure Git Safe Directory
        run: |
          git config --global --add safe.directory C:/GIT/AllergyInsight

      - name: Pull Latest Code
        run: |
          cd C:/GIT/AllergyInsight
          git fetch origin
          git reset --hard origin/prod

      - name: Stop Existing Containers
        run: |
          cd C:/GIT/AllergyInsight
          docker-compose down

      - name: Build and Start Containers
        run: |
          cd C:/GIT/AllergyInsight
          docker-compose up -d --build

      - name: Health Check
        run: |
          Start-Sleep -Seconds 30
          $response = Invoke-WebRequest -Uri "http://localhost:9040/api/health" -UseBasicParsing
          if ($response.StatusCode -ne 200) {
            throw "Health check failed"
          }
          Write-Host "Deployment successful!"

      - name: Show Container Status
        run: |
          docker ps
```

### Self-hosted Runner 설정

```powershell
# Runner 설치 (C:\actions-runner\allergyinsight)
cd C:\actions-runner\allergyinsight

# Runner 구성
.\config.cmd --url https://github.com/bluevlad/AllergyInsight `
             --token YOUR_TOKEN `
             --name allergyinsight-runner `
             --labels Windows,self-hosted `
             --work _work `
             --unattended

# 서비스로 등록 (관리자 권한)
.\svc.cmd install
.\svc.cmd start
```

---

## 6.4 환경별 설정

### 환경 변수 관리

| 변수 | 설명 | Local | Production |
|------|------|-------|------------|
| `DATABASE_URL` | DB 연결 문자열 | localhost:5432 | db:5432 |
| `JWT_SECRET_KEY` | JWT 서명 키 | dev-secret | (비밀) |
| `JWT_EXPIRE_HOURS` | 토큰 만료 시간 | 24 | 24 |
| `VITE_API_URL` | API 서버 URL | localhost:9040 | localhost:9040 |

### .env.example

```env
# Database
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/allergyinsight

# JWT Authentication
JWT_SECRET_KEY=change-this-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRE_HOURS=24

# Google OAuth (Optional)
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=

# Redis (Optional)
REDIS_URL=redis://localhost:6379
```

---

## 6.5 데이터베이스 관리

### 마이그레이션

```bash
# Alembic 초기화 (최초 1회)
cd backend
alembic init alembic

# 마이그레이션 생성
alembic revision --autogenerate -m "Add new table"

# 마이그레이션 적용
alembic upgrade head

# 롤백
alembic downgrade -1
```

### 백업 및 복원

```bash
# 백업
docker exec allergyinsight-db-1 pg_dump -U postgres allergyinsight > backup_$(date +%Y%m%d).sql

# 복원
docker exec -i allergyinsight-db-1 psql -U postgres allergyinsight < backup_20240101.sql
```

### 초기 데이터 시딩

```bash
# Docker 컨테이너 내에서 실행
docker exec -it allergyinsight-backend-1 python -m app.database.seed_papers
```

---

## 6.6 모니터링

### 헬스 체크 엔드포인트

```
GET /api/health

Response:
{
  "status": "healthy",
  "version": "2.0.0",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

### Docker 컨테이너 모니터링

```bash
# 컨테이너 상태
docker ps

# 리소스 사용량
docker stats

# 컨테이너 로그
docker-compose logs -f --tail=100

# 특정 서비스 로그
docker-compose logs backend --since="1h"
```

### 로그 관리

```python
# Backend 로그 설정 (app/core/logging.py)
import logging

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.StreamHandler(),
        logging.FileHandler("app.log")
    ]
)
```

---

## 6.7 트러블슈팅

### 일반적인 문제

#### 1. 컨테이너 시작 실패

```bash
# 로그 확인
docker-compose logs backend

# 일반적인 원인:
# - DB 연결 실패: DATABASE_URL 확인
# - 포트 충돌: netstat -an | findstr 9040
# - 이미지 빌드 오류: docker-compose build --no-cache
```

#### 2. 데이터베이스 연결 오류

```bash
# DB 컨테이너 상태 확인
docker-compose ps db

# DB 접속 테스트
docker exec -it allergyinsight-db-1 psql -U postgres -d allergyinsight

# 네트워크 확인
docker network ls
docker network inspect allergyinsight_allergyinsight
```

#### 3. Frontend 빌드 실패

```bash
# Node 모듈 재설치
docker-compose down
docker volume rm allergyinsight_node_modules
docker-compose up -d --build frontend
```

### 롤백 절차

```bash
# 1. 현재 상태 백업
docker-compose logs > logs_backup.txt

# 2. 이전 버전으로 롤백
git checkout HEAD~1
docker-compose up -d --build

# 3. 상태 확인
curl http://localhost:9040/api/health
```

---

## 6.8 보안 체크리스트

### 배포 전 확인사항

- [ ] JWT_SECRET_KEY 변경 (운영 환경)
- [ ] 디버그 모드 비활성화
- [ ] CORS 설정 확인
- [ ] HTTPS 적용 (운영 환경)
- [ ] 데이터베이스 비밀번호 변경
- [ ] 불필요한 포트 차단
- [ ] 로그에 민감 정보 미포함

### 환경 변수 보안

```bash
# .env 파일은 gitignore에 포함
echo ".env" >> .gitignore

# 운영 환경 변수는 GitHub Secrets 사용
# Settings > Secrets and variables > Actions
```

---

[← 개발 가이드](./5.-Development-Guide) | [다음: 로드맵 →](./7.-Roadmap)
