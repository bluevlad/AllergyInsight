# 2. 아키텍처 (Architecture)

## 2.1 시스템 아키텍처 다이어그램

### 전체 시스템 구조

```
                                    ┌─────────────────┐
                                    │    Internet     │
                                    └────────┬────────┘
                                             │
                                    ┌────────▼────────┐
                                    │   Nginx Proxy   │
                                    │   (Port 4040)   │
                                    └────────┬────────┘
                                             │
                    ┌────────────────────────┼────────────────────────┐
                    │                        │                        │
           ┌────────▼────────┐      ┌────────▼────────┐      ┌────────▼────────┐
           │  Static Files   │      │   /api/*        │      │   WebSocket     │
           │  (React SPA)    │      │   Proxy Pass    │      │   (Future)      │
           └─────────────────┘      └────────┬────────┘      └─────────────────┘
                                             │
                                    ┌────────▼────────┐
                                    │  FastAPI App    │
                                    │   (Port 9040)   │
                                    └────────┬────────┘
                                             │
                    ┌────────────────────────┼────────────────────────┐
                    │                        │                        │
           ┌────────▼────────┐      ┌────────▼────────┐      ┌────────▼────────┐
           │   PostgreSQL    │      │     Redis       │      │  External APIs  │
           │   (Port 5432)   │      │   (Port 6379)   │      │  PubMed, etc.   │
           └─────────────────┘      └─────────────────┘      └─────────────────┘
```

### 컨테이너 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                      Docker Network                              │
├─────────────────┬─────────────────┬─────────────────────────────┤
│                 │                 │                             │
│  ┌───────────┐  │  ┌───────────┐  │  ┌───────────┐              │
│  │ frontend  │  │  │  backend  │  │  │    db     │              │
│  │           │  │  │           │  │  │           │              │
│  │  Nginx    │◄─┼──│  FastAPI  │◄─┼──│ PostgreSQL│              │
│  │  :4040    │  │  │   :9040   │  │  │   :5432   │              │
│  └───────────┘  │  └───────────┘  │  └───────────┘              │
│                 │                 │                             │
└─────────────────┴─────────────────┴─────────────────────────────┘
```

---

## 2.2 서비스 구조 (Professional / Consumer)

### 서비스 이원화 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (React)                         │
├────────────────────────────┬────────────────────────────────────┤
│      Professional App      │          Consumer App              │
│         /pro/*             │            /app/*                  │
├────────────────────────────┼────────────────────────────────────┤
│  ┌──────────────────────┐  │  ┌──────────────────────────────┐  │
│  │ ProNav               │  │  │ ConsumerNav                  │  │
│  │ ├─ Dashboard         │  │  │ ├─ MyDiagnosis               │  │
│  │ ├─ DiagnosisPage     │  │  │ ├─ FoodGuide                 │  │
│  │ ├─ PatientsPage      │  │  │ ├─ Emergency                 │  │
│  │ ├─ SearchPage        │  │  │ ├─ Lifestyle                 │  │
│  │ ├─ QAPage            │  │  │ └─ KitRegister               │  │
│  │ └─ PapersPage        │  │  └──────────────────────────────┘  │
│  └──────────────────────┘  │                                    │
├────────────────────────────┴────────────────────────────────────┤
│                      Shared Components                           │
│           (AuthContext, apiClient, Header, Modal)                │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Backend (FastAPI)                        │
├────────────────────────────┬────────────────────────────────────┤
│     Professional API       │         Consumer API               │
│       /api/pro/*           │       /api/consumer/*              │
├────────────────────────────┼────────────────────────────────────┤
│  ┌──────────────────────┐  │  ┌──────────────────────────────┐  │
│  │ /pro/diagnosis       │  │  │ /consumer/my/diagnoses       │  │
│  │ /pro/patients        │  │  │ /consumer/guide/*            │  │
│  │ /pro/research        │  │  │ /consumer/emergency/*        │  │
│  │ /pro/dashboard       │  │  │ /consumer/kit/*              │  │
│  └──────────────────────┘  │  └──────────────────────────────┘  │
├────────────────────────────┴────────────────────────────────────┤
│                         Core Modules                             │
│              (Auth, Allergen DB, Prescription Engine)            │
└─────────────────────────────────────────────────────────────────┘
```

### 라우팅 구조

| URL 패턴 | 대상 서비스 | 접근 권한 |
|----------|------------|----------|
| `/login` | Public | 모두 |
| `/auth/callback` | Public | 모두 |
| `/pro/*` | Professional App | doctor, nurse, lab_tech, hospital_admin, admin |
| `/app/*` | Consumer App | 인증된 사용자 |
| `/admin/*` | → `/pro` 리다이렉트 | Legacy |
| `/my-diagnosis` | → `/app/my-diagnosis` | Legacy |

---

## 2.3 데이터 흐름도 (Data Flow)

### 진단 입력 흐름 (Professional)

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  의료진   │───▶│ Frontend │───▶│ Backend  │───▶│ Database │
│          │    │          │    │          │    │          │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │               │               │
     │ 1. 진단 입력   │               │               │
     │──────────────▶│               │               │
     │               │ 2. POST /api/pro/diagnosis    │
     │               │──────────────▶│               │
     │               │               │ 3. 처방 엔진   │
     │               │               │   실행        │
     │               │               │──────────────▶│
     │               │               │ 4. 저장       │
     │               │◀──────────────│               │
     │               │ 5. 처방 권고   │               │
     │◀──────────────│   반환        │               │
     │ 6. 결과 표시   │               │               │
```

### 결과 조회 흐름 (Consumer)

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│   환자    │───▶│ Frontend │───▶│ Backend  │───▶│ Database │
│          │    │          │    │          │    │          │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
     │               │               │               │
     │ 1. 결과 요청   │               │               │
     │──────────────▶│               │               │
     │               │ 2. GET /api/consumer/my/diagnoses │
     │               │──────────────▶│               │
     │               │               │ 3. 권한 확인   │
     │               │               │──────────────▶│
     │               │               │ 4. 데이터 조회 │
     │               │◀──────────────│               │
     │               │ 5. 진단 결과 + 가이드          │
     │◀──────────────│               │               │
     │ 6. 결과 표시   │               │               │
```

---

## 2.4 기술 스택 (Tech Stack)

### Backend

| 계층 | 기술 | 버전 | 용도 | 선택 이유 |
|------|------|------|------|----------|
| **Runtime** | Python | 3.11+ | 서버 런타임 | 생산성, AI/ML 생태계 |
| **Framework** | FastAPI | 0.100+ | Web API | 비동기, 타입 힌트, 자동 문서화 |
| **ORM** | SQLAlchemy | 2.0+ | DB 접근 | 유연성, 성숙도 |
| **Validation** | Pydantic | 2.0+ | 데이터 검증 | FastAPI 통합 |
| **Auth** | PyJWT | 2.0+ | JWT 토큰 | 표준, 간편함 |
| **HTTP** | HTTPX | 0.25+ | 외부 API 호출 | 비동기 지원 |

### Frontend

| 계층 | 기술 | 버전 | 용도 | 선택 이유 |
|------|------|------|------|----------|
| **Framework** | React | 18+ | UI 라이브러리 | 생태계, 컴포넌트 기반 |
| **Build** | Vite | 5+ | 번들러 | 빌드 속도, HMR |
| **Routing** | React Router | 6+ | 클라이언트 라우팅 | 표준 |
| **HTTP** | Axios | 1+ | API 통신 | 인터셉터, 에러 처리 |
| **State** | Context API | - | 전역 상태 | 단순함, 내장 |

### Database

| 기술 | 버전 | 용도 | 선택 이유 |
|------|------|------|----------|
| PostgreSQL | 15+ | 주 데이터베이스 | ACID, JSON 지원, 확장성 |
| Redis | 7+ | 캐싱, 세션 | 성능, 간편함 |

### Infrastructure

| 기술 | 용도 | 비고 |
|------|------|------|
| Docker | 컨테이너화 | 개발/운영 환경 일치 |
| Docker Compose | 로컬 오케스트레이션 | 개발 환경 |
| Nginx | 리버스 프록시 | 정적 파일, API 프록시 |
| GitHub Actions | CI/CD | 자동 배포 |

### 기술 스택 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                        Presentation                          │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │
│  │  React  │  │  Vite   │  │ Router  │  │  Axios          │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                         API Layer                            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │
│  │ FastAPI │  │Pydantic │  │  JWT    │  │  OAuth2         │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                       Business Logic                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │Prescription Eng.│  │  Paper Search   │  │   QA Engine  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                        Data Layer                            │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │
│  │SQLAlchemy│  │PostgreSQL│ │  Redis  │  │  Allergen DB   │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                       Infrastructure                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────────┐ │
│  │ Docker  │  │  Nginx  │  │ GitHub  │  │ Actions         │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 2.5 인프라 구성

### 개발 환경

```yaml
# docker-compose.yml
services:
  frontend:
    build: ./frontend
    ports: ["4040:4040"]

  backend:
    build: ./backend
    ports: ["9040:9040"]
    depends_on: [db]

  db:
    image: postgres:15-alpine
    ports: ["5432:5432"]
```

### 운영 환경 (예정)

```
┌─────────────────────────────────────────────────────────────┐
│                         Cloud (AWS/GCP)                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   ┌────────────┐     ┌────────────┐     ┌────────────┐      │
│   │    CDN     │────▶│   Load     │────▶│  Container │      │
│   │ CloudFront │     │  Balancer  │     │   (ECS)    │      │
│   └────────────┘     └────────────┘     └────────────┘      │
│                                               │              │
│                            ┌──────────────────┼──────────┐   │
│                            │                  │          │   │
│                       ┌────▼────┐        ┌────▼────┐     │   │
│                       │   RDS   │        │  Redis  │     │   │
│                       │(Postgres)│       │ElastiCache│    │   │
│                       └─────────┘        └─────────┘     │   │
│                                                          │   │
└──────────────────────────────────────────────────────────┘   │
```

### 환경별 설정

| 환경 | 용도 | 특징 |
|------|------|------|
| **local** | 개발 | Docker Compose, Hot Reload |
| **dev** | 개발 서버 | 테스트 데이터, 디버그 모드 |
| **staging** | 스테이징 | 운영과 동일 구성, 테스트 |
| **prod** | 운영 | 고가용성, 모니터링, 백업 |

---

## 2.6 보안 아키텍처

### 인증 흐름

```
┌────────────┐          ┌────────────┐          ┌────────────┐
│   Client   │          │   Backend  │          │  Database  │
└─────┬──────┘          └─────┬──────┘          └─────┬──────┘
      │                       │                       │
      │ 1. Login Request      │                       │
      │ (credentials)         │                       │
      │──────────────────────▶│                       │
      │                       │ 2. Verify User        │
      │                       │──────────────────────▶│
      │                       │◀──────────────────────│
      │                       │ 3. Generate JWT       │
      │ 4. JWT Token          │                       │
      │◀──────────────────────│                       │
      │                       │                       │
      │ 5. API Request        │                       │
      │ (with JWT)            │                       │
      │──────────────────────▶│                       │
      │                       │ 6. Verify JWT         │
      │                       │ 7. Check Permissions  │
      │ 8. Response           │                       │
      │◀──────────────────────│                       │
```

### 인가 (Authorization)

| 역할 | Professional API | Consumer API | Admin API |
|------|-----------------|--------------|-----------|
| patient | ❌ | ✅ | ❌ |
| doctor | ✅ | ✅ | ❌ |
| nurse | ✅ | ✅ | ❌ |
| lab_tech | ✅ (제한적) | ✅ | ❌ |
| hospital_admin | ✅ | ✅ | ✅ (병원) |
| admin | ✅ | ✅ | ✅ |
| super_admin | ✅ | ✅ | ✅ |

---

## 2.7 확장성 고려사항

### 현재 (Monolith)
```
┌─────────────────────────────────┐
│         AllergyInsight          │
│  ┌───────────────────────────┐  │
│  │      All Features         │  │
│  │  (Pro + Consumer + Core)  │  │
│  └───────────────────────────┘  │
└─────────────────────────────────┘
```

### 향후 (Modular Monolith → Microservices)
```
┌─────────────────────────────────────────────────────────────┐
│                         API Gateway                          │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼───────┐     ┌───────▼───────┐     ┌───────▼───────┐
│  Auth Service │     │  Pro Service  │     │Consumer Service│
└───────────────┘     └───────────────┘     └───────────────┘
```

---

[← 프로젝트 개요](./1.-Project-Overview) | [다음: 도메인 모델 →](./3.-Domain-Model)
