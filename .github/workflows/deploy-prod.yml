name: Deploy to Production

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    name: Deploy AllergyInsight
    runs-on: [self-hosted, Windows]

    defaults:
      run:
        working-directory: C:\GIT\AllergyInsight

    steps:
      - name: Configure git safe directory
        working-directory: C:\
        run: git config --global --add safe.directory C:/GIT/AllergyInsight

      - name: Pull latest changes
        run: |
          git fetch origin prod
          git checkout prod
          git reset --hard origin/prod

      - name: Check if Docker restart needed
        id: check-docker
        run: |
          # 최근 커밋에서 변경된 파일 확인
          $changedFiles = git diff --name-only HEAD~1 HEAD

          Write-Host "Changed files:"
          Write-Host $changedFiles

          # Docker 재시작이 필요한 패턴
          $dockerPaths = @(
            'backend/',
            'frontend/',
            'docker-compose.yml',
            'Dockerfile',
            '.env'
          )

          $needRestart = $false
          foreach ($file in $changedFiles -split "`n") {
            foreach ($path in $dockerPaths) {
              if ($file -like "$path*") {
                $needRestart = $true
                Write-Host "Docker restart needed: $file matches $path"
                break
              }
            }
            if ($needRestart) { break }
          }

          Write-Host "Need Docker restart: $needRestart"
          echo "need_restart=$needRestart" >> $env:GITHUB_OUTPUT

      - name: Stop existing containers
        if: steps.check-docker.outputs.need_restart == 'True'
        run: docker-compose down
        continue-on-error: true

      - name: Build and start containers
        if: steps.check-docker.outputs.need_restart == 'True'
        run: docker-compose up -d --build

      - name: Wait for services to be healthy
        if: steps.check-docker.outputs.need_restart == 'True'
        run: |
          echo "Waiting for services to start..."
          Start-Sleep -Seconds 30

      - name: Health check
        if: steps.check-docker.outputs.need_restart == 'True'
        run: |
          $response = Invoke-WebRequest -Uri "http://localhost:9040/api/health" -UseBasicParsing -TimeoutSec 10
          if ($response.StatusCode -eq 200) {
            echo "Backend is healthy!"
          } else {
            echo "Backend health check failed!"
            exit 1
          }
        continue-on-error: true

      - name: Show container status
        if: steps.check-docker.outputs.need_restart == 'True'
        run: docker-compose ps

      - name: Skip Docker restart (docs/config only)
        if: steps.check-docker.outputs.need_restart != 'True'
        run: |
          Write-Host "=========================================="
          Write-Host "Docker restart SKIPPED"
          Write-Host "Only docs/config files were changed"
          Write-Host "=========================================="

      - name: Deployment complete
        run: |
          if ("${{ steps.check-docker.outputs.need_restart }}" -eq "True") {
            echo "AllergyInsight deployed with Docker restart!"
          } else {
            echo "AllergyInsight synced (docs/config only, no Docker restart)"
          }
